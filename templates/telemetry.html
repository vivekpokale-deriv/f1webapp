<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e10600;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #15151e;
            color: white;
            font-weight: bold;
        }
        .footer {
            background-color: #15151e;
            color: white;
            padding: 20px 0;
            margin-top: 30px;
        }
        .visualization-container {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Specific heights for different visualization types */
        .speed-trace-container {
            height: 450px;
        }
        
        .gear-shifts-container {
            min-height: 350px;
            position: relative;
        }
        
        .track-dominance-container {
            min-height: 500px;
            position: relative;
        }
        
        /* Dimension display */
        .visualization-container .text-muted {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>F1 Telemetry Visualization</h1>
            <p class="lead">Interactive Formula 1 telemetry data visualization</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="form-container">
                    <h4>Select Data to Visualize</h4>
                    <form id="telemetry-form">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="year" class="form-label">Year</label>
                                    <select class="form-select" id="year" required>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="race" class="form-label">Race</label>
                                    <select class="form-select" id="race" required>
                                        <option value="Bahrain">Bahrain</option>
                                        <option value="Saudi_Arabia">Saudi Arabia</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Azerbaijan">Azerbaijan</option>
                                        <option value="Miami">Miami</option>
                                        <option value="Monaco">Monaco</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Austria">Austria</option>
                                        <option value="Great_Britain">Great Britain</option>
                                        <option value="Hungary">Hungary</option>
                                        <option value="Belgium">Belgium</option>
                                        <option value="Netherlands">Netherlands</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Qatar">Qatar</option>
                                        <option value="United_States">United States</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Las_Vegas">Las Vegas</option>
                                        <option value="Abu_Dhabi">Abu Dhabi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="session" class="form-label">Session</label>
                                    <select class="form-select" id="session" required>
                                        <option value="R">Race</option>
                                        <option value="Q">Qualifying</option>
                                        <option value="FP1">Practice 1</option>
                                        <option value="FP2">Practice 2</option>
                                        <option value="FP3">Practice 3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="driver1" class="form-label">Driver 1</label>
                                    <select class="form-select" id="driver1" required>
                                        <option value="VER">Verstappen</option>
                                        <option value="HAM">Hamilton</option>
                                        <option value="LEC">Leclerc</option>
                                        <option value="PER">Perez</option>
                                        <option value="SAI">Sainz</option>
                                        <option value="RUS">Russell</option>
                                        <option value="NOR">Norris</option>
                                        <option value="PIA">Piastri</option>
                                        <option value="ALO">Alonso</option>
                                        <option value="STR">Stroll</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="driver2" class="form-label">Driver 2</label>
                                    <select class="form-select" id="driver2" required>
                                        <option value="HAM">Hamilton</option>
                                        <option value="VER">Verstappen</option>
                                        <option value="LEC">Leclerc</option>
                                        <option value="PER">Perez</option>
                                        <option value="SAI">Sainz</option>
                                        <option value="RUS">Russell</option>
                                        <option value="NOR">Norris</option>
                                        <option value="PIA">Piastri</option>
                                        <option value="ALO">Alonso</option>
                                        <option value="STR">Stroll</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">Load</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="view-toggle">
                                    <label class="form-check-label" for="view-toggle">Combined View</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Combined visualization view -->
        <div id="combined-view" style="display: none;">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">Combined Visualization</div>
                        <div class="card-body">
                            <div class="visualization-container" style="height: 800px;">
                                <img id="combined-visualization" src="" alt="Combined visualization" style="max-width: 100%; max-height: 100%;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Separate visualizations view -->
        <div id="separate-view">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">Speed Trace</div>
                        <div class="card-body">
                            <div class="visualization-container speed-trace-container">
                                <canvas id="speed-trace-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Gear Shifts - Both Drivers</span>
                            <div class="d-flex gap-2">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <span class="input-group-text">W</span>
                                    <input type="number" class="form-control" id="gear-shifts-svg-width" value="800" min="400" max="1500">
                                </div>
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <span class="input-group-text">H</span>
                                    <input type="number" class="form-control" id="gear-shifts-svg-height" value="400" min="300" max="800">
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="F1Telemetry.updateVisualizationSize('gear-shifts-svg')">Apply</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="visualization-container gear-shifts-container">
                                <svg id="gear-shifts-svg" width="800" height="400"></svg>
                                <div id="gear-shifts-svg-dimensions" class="text-muted small position-absolute bottom-0 end-0 p-2">800×400</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Track Dominance</span>
                            <div class="d-flex gap-2">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <span class="input-group-text">W</span>
                                    <input type="number" class="form-control" id="track-dominance-svg-width" value="800" min="300" max="1500">
                                </div>
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <span class="input-group-text">H</span>
                                    <input type="number" class="form-control" id="track-dominance-svg-height" value="500" min="300" max="900">
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="F1Telemetry.updateVisualizationSize('track-dominance-svg')">Apply</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="visualization-container track-dominance-container">
                                <svg id="track-dominance-svg" width="800" height="500"></svg>
                                <div id="track-dominance-svg-dimensions" class="text-muted small position-absolute bottom-0 end-0 p-2">800×500</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>&copy; 2025 F1 Data Visualization</p>
        </div>
    </div>

    <!-- Load libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Load our telemetry script -->
    <script src="{{ url_for('static', filename='js/telemetry.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const telemetryForm = document.getElementById('telemetry-form');
            const viewToggle = document.getElementById('view-toggle');
            const combinedView = document.getElementById('combined-view');
            const separateView = document.getElementById('separate-view');
            const combinedVisualization = document.getElementById('combined-visualization');
            
            // Function to clean up charts and visualizations
            function cleanupVisualizations() {
                // Clean up Chart.js instances
                if (window.F1Telemetry && window.F1Telemetry.chartInstances) {
                    Object.values(window.F1Telemetry.chartInstances).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
                
                // Clean up D3.js visualizations
                d3.select('#gear-shifts-svg-driver1').selectAll('*').remove();
                d3.select('#gear-shifts-svg-driver2').selectAll('*').remove();
                d3.select('#track-dominance-svg').selectAll('*').remove();
            }
            
            // Function to toggle between views
            function toggleView() {
                cleanupVisualizations();
                
                if (viewToggle.checked) {
                    combinedView.style.display = 'block';
                    separateView.style.display = 'none';
                } else {
                    combinedView.style.display = 'none';
                    separateView.style.display = 'block';
                }
            }
            
            // Add event listener for the view toggle
            viewToggle.addEventListener('change', toggleView);
            
            // Function to show loading state
            function showLoading() {
                document.querySelectorAll('.visualization-container').forEach(container => {
                    container.classList.add('loading');
                    container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading data...</p></div>';
                });
            }
            
            // Function to hide loading state
            function hideLoading() {
                document.querySelectorAll('.visualization-container').forEach(container => {
                    container.classList.remove('loading');
                    container.innerHTML = '';
                });
            }
            
            // Function to load data based on current view
            async function loadData() {
                const year = document.getElementById('year').value;
                const race = document.getElementById('race').value;
                const session = document.getElementById('session').value;
                const driver1 = document.getElementById('driver1').value;
                const driver2 = document.getElementById('driver2').value;
                
                try {
                    if (viewToggle.checked) {
                        // Show loading state
                        document.querySelector('#combined-view .visualization-container').innerHTML = 
                            '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading combined visualization...</p></div>';
                        
                        // Load combined visualization
                        const response = await fetch(`/api/telemetry/combined/${year}/${race}/${session}/${driver1}/${driver2}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            // Add timestamp to prevent caching
                            combinedVisualization.src = `/${data.data.image_path}?t=${new Date().getTime()}`;
                            document.querySelector('#combined-view .visualization-container').innerHTML = '';
                            document.querySelector('#combined-view .visualization-container').appendChild(combinedVisualization);
                        } else {
                            throw new Error(data.error || 'Failed to load combined visualization');
                        }
                    } else {
                        // Recreate canvas and SVG elements
                        const speedTraceContainer = document.querySelector('#speed-trace-chart').parentNode;
                        speedTraceContainer.innerHTML = '<canvas id="speed-trace-chart"></canvas>';
                        
                        // Get the width and height values from the input fields
                        const gearShiftsWidth = parseInt(document.getElementById('gear-shifts-svg-width').value, 10);
                        const gearShiftsHeight = parseInt(document.getElementById('gear-shifts-svg-height').value, 10);
                        const trackDominanceWidth = parseInt(document.getElementById('track-dominance-svg-width').value, 10);
                        const trackDominanceHeight = parseInt(document.getElementById('track-dominance-svg-height').value, 10);
                        
                        const gearShiftsContainer = document.querySelector('#gear-shifts-svg').parentNode;
                        gearShiftsContainer.innerHTML = `<svg id="gear-shifts-svg" width="${gearShiftsWidth}" height="${gearShiftsHeight}"></svg>
                                                        <div id="gear-shifts-svg-dimensions" class="text-muted small position-absolute bottom-0 end-0 p-2">${gearShiftsWidth}×${gearShiftsHeight}</div>`;
                        
                        const trackDominanceContainer = document.querySelector('#track-dominance-svg').parentNode;
                        trackDominanceContainer.innerHTML = `<svg id="track-dominance-svg" width="${trackDominanceWidth}" height="${trackDominanceHeight}"></svg>
                                                           <div id="track-dominance-svg-dimensions" class="text-muted small position-absolute bottom-0 end-0 p-2">${trackDominanceWidth}×${trackDominanceHeight}</div>`;
                        
                        // Load separate visualizations
                        try {
                            // Load speed trace data
                            const speedTraceData = await window.F1Telemetry.fetchSpeedTraceData(
                                year, race, session, driver1, driver2
                            );
                            window.F1Telemetry.visualizeSpeedTrace(speedTraceData, 'speed-trace-chart');
                        } catch (error) {
                            console.error('Error loading speed trace data:', error);
                            speedTraceContainer.innerHTML = 
                                `<div class="alert alert-danger">Error loading speed trace data: ${error.message}</div>`;
                        }
                        
                        try {
                            // Load gear shift data for both drivers
                            const gearShiftDataDriver1Promise = window.F1Telemetry.fetchGearShiftData(
                                year, race, session, driver1
                            );
                            
                            const gearShiftDataDriver2Promise = window.F1Telemetry.fetchGearShiftData(
                                year, race, session, driver2
                            );
                            
                            // Wait for both promises to resolve
                            const [gearShiftDataDriver1, gearShiftDataDriver2] = await Promise.all([
                                gearShiftDataDriver1Promise, 
                                gearShiftDataDriver2Promise
                            ]);
                            
                            // Visualize combined gear shifts
                            window.F1Telemetry.visualizeCombinedGearShifts(
                                gearShiftDataDriver1, 
                                gearShiftDataDriver2, 
                                'gear-shifts-svg', 
                                gearShiftsWidth, 
                                gearShiftsHeight
                            );
                        } catch (error) {
                            console.error('Error loading gear shift data:', error);
                            gearShiftsContainer.innerHTML = 
                                `<div class="alert alert-danger">Error loading gear shift data: ${error.message}</div>`;
                        }
                        
                        try {
                            // Load track dominance data
                            const trackDominanceData = await window.F1Telemetry.fetchTrackDominanceData(
                                year, race, session, [driver1, driver2]
                            );
                            window.F1Telemetry.visualizeTrackDominance(trackDominanceData, 'track-dominance-svg', trackDominanceWidth, trackDominanceHeight);
                        } catch (error) {
                            console.error('Error loading track dominance data:', error);
                            trackDominanceContainer.innerHTML = 
                                `<div class="alert alert-danger">Error loading track dominance data: ${error.message}</div>`;
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert(`Error loading data: ${error.message}. Please try again.`);
                }
            }
            
            // Add event listener for form submission
            telemetryForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                cleanupVisualizations();
                await loadData();
            });
            
            // Add event listener for view toggle
            viewToggle.addEventListener('change', async function() {
                toggleView();
                await loadData();
            });
            
            // Initialize view
            toggleView();
            
            // Load default data on page load
            telemetryForm.dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>
