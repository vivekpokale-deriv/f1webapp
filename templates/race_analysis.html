<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Race Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #e10600;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #15151e;
            color: white;
            font-weight: bold;
        }
        .footer {
            background-color: #15151e;
            color: white;
            padding: 20px 0;
            margin-top: 30px;
        }
        .visualization-container {
            position: relative;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Specific heights for different visualization types */
        .race-pace-container {
            height: 450px;
        }
        
        .team-pace-container {
            height: 500px;
        }
        
        .lap-sections-container {
            height: 600px;
        }
        
        /* Dimension display */
        .visualization-container .text-muted {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .form-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .nav-pills .nav-link.active {
            background-color: #e10600;
        }
        .nav-pills .nav-link {
            color: #15151e;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>F1 Race Analysis</h1>
            <p class="lead">Interactive Formula 1 race data analysis</p>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <ul class="nav nav-pills nav-fill">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/telemetry">Telemetry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/race-analysis">Race Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/info">Information</a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="form-container">
                    <h4>Select Data to Analyze</h4>
                    <form id="analysis-form">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="year" class="form-label">Year</label>
                                    <select class="form-select" id="year" required>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="race" class="form-label">Race</label>
                                    <select class="form-select" id="race" required>
                                        <option value="Bahrain">Bahrain</option>
                                        <option value="Saudi_Arabia">Saudi Arabia</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Azerbaijan">Azerbaijan</option>
                                        <option value="Miami">Miami</option>
                                        <option value="Monaco">Monaco</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Austria">Austria</option>
                                        <option value="Great_Britain">Great Britain</option>
                                        <option value="Hungary">Hungary</option>
                                        <option value="Belgium">Belgium</option>
                                        <option value="Netherlands">Netherlands</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Qatar">Qatar</option>
                                        <option value="United_States">United States</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Las_Vegas">Las Vegas</option>
                                        <option value="Abu_Dhabi">Abu Dhabi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="analysis-type" class="form-label">Analysis Type</label>
                                    <select class="form-select" id="analysis-type" required>
                                        <option value="race-pace">Race Pace</option>
                                        <option value="team-pace">Team Pace</option>
                                        <option value="lap-sections">Lap Sections</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="session" class="form-label">Session</label>
                                    <select class="form-select" id="session" required>
                                        <option value="R">Race</option>
                                        <option value="Q">Qualifying</option>
                                        <option value="FP1">Practice 1</option>
                                        <option value="FP2">Practice 2</option>
                                        <option value="FP3">Practice 3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="drivers" class="form-label">Drivers (optional)</label>
                                    <input type="text" class="form-control" id="drivers" placeholder="VER,HAM,LEC">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">Load</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="view-toggle" checked>
                                    <label class="form-check-label" for="view-toggle">Interactive View</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Static image view -->
        <div id="static-view">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <span id="static-view-title">Race Analysis</span>
                        </div>
                        <div class="card-body">
                            <div class="visualization-container" id="static-container">
                                <img id="static-visualization" src="" alt="Race analysis visualization" style="max-width: 100%; max-height: 100%;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive view -->
        <div id="interactive-view" style="display: none;">
            <!-- Race Pace View -->
            <div id="race-pace-view">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">Race Pace Comparison</div>
                            <div class="card-body">
                                <div class="visualization-container race-pace-container">
                                    <canvas id="race-pace-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Pace View -->
            <div id="team-pace-view" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">Team Pace Comparison</div>
                            <div class="card-body">
                                <div class="visualization-container team-pace-container">
                                    <canvas id="team-pace-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lap Sections View -->
            <div id="lap-sections-view" style="display: none;">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">Lap Sections Analysis</div>
                            <div class="card-body">
                                <div class="visualization-container lap-sections-container">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="section-chart-container">
                                                <h5>Braking</h5>
                                                <canvas id="braking-chart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="section-chart-container">
                                                <h5>Cornering</h5>
                                                <canvas id="cornering-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <div class="section-chart-container">
                                                <h5>Acceleration</h5>
                                                <canvas id="acceleration-chart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="section-chart-container">
                                                <h5>Full Throttle</h5>
                                                <canvas id="full-throttle-chart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>&copy; 2025 F1 Data Visualization</p>
        </div>
    </div>

    <!-- Load libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    
    <!-- Load our race analysis script -->
    <script src="{{ url_for('static', filename='js/race_analysis.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analysisForm = document.getElementById('analysis-form');
            const viewToggle = document.getElementById('view-toggle');
            const staticView = document.getElementById('static-view');
            const interactiveView = document.getElementById('interactive-view');
            const staticVisualization = document.getElementById('static-visualization');
            const analysisType = document.getElementById('analysis-type');
            const sessionSelect = document.getElementById('session');
            
            // Analysis type views
            const racePaceView = document.getElementById('race-pace-view');
            const teamPaceView = document.getElementById('team-pace-view');
            const lapSectionsView = document.getElementById('lap-sections-view');
            
            // Function to clean up charts
            function cleanupCharts() {
                // Clean up Chart.js instances
                if (window.F1RaceAnalysis && window.F1RaceAnalysis.chartInstances) {
                    Object.values(window.F1RaceAnalysis.chartInstances).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
            }
            
            // Function to toggle between views
            function toggleView() {
                cleanupCharts();
                
                if (viewToggle.checked) {
                    staticView.style.display = 'none';
                    interactiveView.style.display = 'block';
                    
                    // Show the appropriate analysis view
                    const type = analysisType.value;
                    racePaceView.style.display = type === 'race-pace' ? 'block' : 'none';
                    teamPaceView.style.display = type === 'team-pace' ? 'block' : 'none';
                    lapSectionsView.style.display = type === 'lap-sections' ? 'block' : 'none';
                    
                    // Ensure the canvas elements are properly initialized
                    setTimeout(() => {
                        if (type === 'race-pace') {
                            const canvas = document.getElementById('race-pace-chart');
                            if (canvas) {
                                canvas.width = canvas.parentNode.clientWidth;
                                canvas.height = canvas.parentNode.clientHeight;
                            }
                        } else if (type === 'team-pace') {
                            const canvas = document.getElementById('team-pace-chart');
                            if (canvas) {
                                canvas.width = canvas.parentNode.clientWidth;
                                canvas.height = canvas.parentNode.clientHeight;
                            }
                        } else if (type === 'lap-sections') {
                            ['braking-chart', 'cornering-chart', 'acceleration-chart', 'full-throttle-chart'].forEach(id => {
                                const canvas = document.getElementById(id);
                                if (canvas) {
                                    canvas.width = canvas.parentNode.clientWidth;
                                    canvas.height = canvas.parentNode.clientHeight;
                                }
                            });
                        }
                    }, 0);
                } else {
                    staticView.style.display = 'block';
                    interactiveView.style.display = 'none';
                }
            }
            
            // Add event listener for the view toggle
            viewToggle.addEventListener('change', toggleView);
            
            // Add event listener for analysis type change
            analysisType.addEventListener('change', function() {
                const type = this.value;
                
                // Update session visibility based on analysis type
                if (type === 'race-pace' || type === 'team-pace') {
                    sessionSelect.value = 'R';
                    sessionSelect.disabled = true;
                } else {
                    sessionSelect.disabled = false;
                }
                
                // Update views if in interactive mode
                if (viewToggle.checked) {
                    racePaceView.style.display = type === 'race-pace' ? 'block' : 'none';
                    teamPaceView.style.display = type === 'team-pace' ? 'block' : 'none';
                    lapSectionsView.style.display = type === 'lap-sections' ? 'block' : 'none';
                }
            });
            
            // Function to show loading state
            function showLoading(container) {
                // Add loading spinner without removing canvas elements
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-overlay';
                loadingDiv.style.position = 'absolute';
                loadingDiv.style.top = '0';
                loadingDiv.style.left = '0';
                loadingDiv.style.width = '100%';
                loadingDiv.style.height = '100%';
                loadingDiv.style.display = 'flex';
                loadingDiv.style.justifyContent = 'center';
                loadingDiv.style.alignItems = 'center';
                loadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                loadingDiv.style.zIndex = '10';
                
                loadingDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading data...</p></div>';
                
                // Remove any existing loading overlays
                const existingOverlays = container.querySelectorAll('.loading-overlay');
                existingOverlays.forEach(overlay => overlay.remove());
                
                // Add the new loading overlay
                container.appendChild(loadingDiv);
                
                return loadingDiv;
            }
            
            // Function to load data based on current view and analysis type
            async function loadData() {
                const year = document.getElementById('year').value;
                const race = document.getElementById('race').value;
                const type = document.getElementById('analysis-type').value;
                const session = document.getElementById('session').value;
                const drivers = document.getElementById('drivers').value;
                
                // Update static view title
                const staticViewTitle = document.getElementById('static-view-title');
                if (type === 'race-pace') {
                    staticViewTitle.textContent = 'Race Pace Comparison';
                } else if (type === 'team-pace') {
                    staticViewTitle.textContent = 'Team Pace Comparison';
                } else if (type === 'lap-sections') {
                    staticViewTitle.textContent = 'Lap Sections Analysis';
                }
                
                try {
                    if (!viewToggle.checked) {
                        // Static view - load image
                        const staticContainer = document.getElementById('static-container');
                        showLoading(staticContainer);
                        
                        let imageUrl;
                        if (type === 'race-pace') {
                            imageUrl = `/api/race-analysis/race-pace-plot/${year}/${race}`;
                            if (drivers) {
                                imageUrl += `?drivers=${drivers}`;
                            }
                        } else if (type === 'team-pace') {
                            imageUrl = `/api/race-analysis/team-pace-plot/${year}/${race}`;
                        } else if (type === 'lap-sections') {
                            imageUrl = `/api/race-analysis/lap-sections-plot/${year}/${race}/${session}`;
                            if (drivers) {
                                imageUrl += `?drivers=${drivers}`;
                            }
                        }
                        
                        // Add timestamp to prevent caching
                        imageUrl += `${imageUrl.includes('?') ? '&' : '?'}t=${new Date().getTime()}`;
                        
                        // Load the image
                        staticVisualization.src = imageUrl;
                        staticVisualization.onload = function() {
                            staticContainer.innerHTML = '';
                            staticContainer.appendChild(staticVisualization);
                        };
                        staticVisualization.onerror = function() {
                            staticContainer.innerHTML = '<div class="alert alert-danger">Error loading visualization. Please try again.</div>';
                        };
                    } else {
                        // Interactive view - load data and create charts
                        if (type === 'race-pace') {
                            const racePaceContainer = document.querySelector('#race-pace-chart').parentNode;
                            showLoading(racePaceContainer);
                            
                            try {
                                // Make sure the canvas is visible
                                const canvas = document.getElementById('race-pace-chart');
                                if (canvas) {
                                    canvas.style.display = 'block';
                                    canvas.width = racePaceContainer.clientWidth;
                                    canvas.height = racePaceContainer.clientHeight;
                                }
                                
                                const racePaceData = await window.F1RaceAnalysis.fetchRacePaceData(year, race, drivers);
                                window.F1RaceAnalysis.visualizeRacePace(racePaceData, 'race-pace-chart');
                            } catch (error) {
                                console.error('Error loading race pace data:', error);
                                racePaceContainer.innerHTML = 
                                    `<div class="alert alert-danger">Error loading race pace data: ${error.message}</div>`;
                            }
                        } else if (type === 'team-pace') {
                            const teamPaceContainer = document.querySelector('#team-pace-chart').parentNode;
                            showLoading(teamPaceContainer);
                            
                            try {
                                // Make sure the canvas is visible
                                const canvas = document.getElementById('team-pace-chart');
                                if (canvas) {
                                    canvas.style.display = 'block';
                                    canvas.width = teamPaceContainer.clientWidth;
                                    canvas.height = teamPaceContainer.clientHeight;
                                }
                                
                                const teamPaceData = await window.F1RaceAnalysis.fetchTeamPaceData(year, race);
                                window.F1RaceAnalysis.visualizeTeamPace(teamPaceData, 'team-pace-chart');
                            } catch (error) {
                                console.error('Error loading team pace data:', error);
                                teamPaceContainer.innerHTML = 
                                    `<div class="alert alert-danger">Error loading team pace data: ${error.message}</div>`;
                            }
                        } else if (type === 'lap-sections') {
                            const lapSectionsContainer = document.querySelector('.lap-sections-container');
                            showLoading(lapSectionsContainer);
                            
                            try {
                                // Make sure the canvas elements are visible
                                ['braking-chart', 'cornering-chart', 'acceleration-chart', 'full-throttle-chart'].forEach(id => {
                                    const canvas = document.getElementById(id);
                                    if (canvas) {
                                        canvas.style.display = 'block';
                                        const container = canvas.parentNode;
                                        if (container) {
                                            canvas.width = container.clientWidth;
                                            canvas.height = container.clientHeight;
                                        }
                                    }
                                });
                                
                                const lapSectionsData = await window.F1RaceAnalysis.fetchLapSectionsData(year, race, session, drivers);
                                window.F1RaceAnalysis.visualizeLapSections(lapSectionsData);
                            } catch (error) {
                                console.error('Error loading lap sections data:', error);
                                lapSectionsContainer.innerHTML = 
                                    `<div class="alert alert-danger">Error loading lap sections data: ${error.message}</div>`;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    alert(`Error loading data: ${error.message}. Please try again.`);
                }
            }
            
            // Add event listener for form submission
            analysisForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                cleanupCharts();
                await loadData();
            });
            
            // Add event listener for view toggle
            viewToggle.addEventListener('change', async function() {
                toggleView();
                await loadData();
            });
            
            // Initialize view
            toggleView();
            
            // Trigger analysis type change to set initial state
            analysisType.dispatchEvent(new Event('change'));
            
            // Load default data on page load
            analysisForm.dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>
